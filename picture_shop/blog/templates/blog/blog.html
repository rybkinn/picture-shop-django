{% extends 'base.html' %}
{% load static %}
{% load sidebar %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<section class="section"
    data-preset="{&quot;title&quot;:&quot;Breadcrumbs Classic&quot;,&quot;category&quot;:&quot;breadcrumbs&quot;,&quot;id&quot;:&quot;breadcrumbs-classic&quot;}">
    <div class="shell-wide">
        <div class="bg-dark-overlay section-bredcrumbs custom-bg-image novi-background bg-image-breadcrumbs-1">
            <div class="breadcrumb-wrapper">
                <h1 class="title">Блог</h1>
                <ol class="breadcrumbs-custom">
                    <li><a href="./">Главная</a></li>
                    <li><a href="#">Блог</a></li>
                </ol>
            </div>
        </div>
    </div>
</section>
<section class="section section-lg bg-white novi-background bg-cover"
    data-preset="{&quot;title&quot;:&quot;Grid Blog&quot;,&quot;category&quot;:&quot;blog&quot;,&quot;id&quot;:&quot;grid-blog&quot;}">
    <div class="shell shell-wide">
        <div class="range range-40 range-center range-fix">
            <div class="cell-sm-10 cell-md-8">
                <div class="range range-30">

                    {% for post in posts %}
                    <div class="cell-sm-6 cell-flex">
                        <article class="post-grid custom-bg-image"
                            style="background-image: url({{ post.background_image.url }});">
                            <div class="post-item">
                                <div class="post-author">
                                    <a class="author-media" href="#">
                                        {% for user in users %}
{#                                            {% if user.avatar|lower == '' %}#}
{#                                                <img src="\media\users\avatar\default_avatar.jpg" alt="" width="50" ></a>#}
                                            {% if user.username|lower == post.author|lower %}
                                                <img src="{{ user.avatar.url }}" alt="" width="50" ></a>
                                            {% endif %}
                                        {% endfor %}
                                    <a class="author-name" href="#">{{ post.author }}</a>
                                </div>
                            </div>
                            <div class="post-item">
                                <div class="content">
                                    <div class="time">
                                        <time>{{ post.post_time }}</time>
                                    </div>
                                    <h4 class="post-title">
                                        <a href="{{ post.slug }}">{{ post.title }}</a>
                                    </h4>
                                    <div class="post-exeption">
                                        <p>{{ post.description|truncatewords_html:20|safe }}</p>
                                    </div>
                                </div>
                            </div>
                        </article>
                    </div>
                    {% endfor %}

                </div>
                <div class="post-bottom text-center">
                    <button id="show_more_posts" class="button button-primary-outline button-icon button-icon-left">
                        <span>
                            <span class="icon mdi mdi-refresh"></span>
                            Больше публикаций
                        </span>
                    </button>
                </div>
            </div>

            <script src="{% static 'js/jquery.min.js' %}"></script>
            <script type="text/javascript">
                let posts_left = {{ posts_left }};
                if (posts_left <= 0){
                    document.querySelector('.post-bottom.text-center').remove();
                }
                posts_left = undefined;

                $('#show_more_posts').click(function(){
                    $.ajax(
                    {
                        type:"GET",
                        url: "get_posts/",
                        dataType: "json",
                        data:{},
                        success: function(data)
                        {
                            if (data){
                                let _json = JSON.parse(JSON.stringify(data))
                                let posts_left = _json[0]['total_posts_count']
                                console.log(data)

                                if (data.length > 1){

                                    for (let iter = 0, item = 1; iter < data.length - 1; iter++, item++ ){

                                        let background_image = _json[item]['background_image']
                                        let description = _json[item]['description']
                                        let post_time = _json[item]['post_time']
                                        let slug = _json[item]['slug']
                                        let title = _json[item]['title']
                                        let author = _json[item]['author']
                                        let author_avatar = _json[item]['author_avatar']

                                        if (posts_left <= 0){
                                            $('#show_more_posts').remove();
                                        }
                                        $('.section-lg .range-30 ').append(`
                                            <div class="cell-sm-6 cell-flex">
                                                <article class="post-grid custom-bg-image"
                                                    style="background-image: url(${background_image});">
                                                    <div class="post-item">
                                                        <div class="post-author">
                                                            <a class="author-media" href="#">
                                                                <img src="${author_avatar}" alt="" width="50" ></a>
                                                            <a class="author-name" href="#">${author}</a>
                                                        </div>
                                                    </div>
                                                    <div class="post-item">
                                                        <div class="content">
                                                            <div class="time">
                                                                <time>${post_time}</time>
                                                            </div>
                                                            <h4 class="post-title">
                                                                <a href="${slug}">${title}</a>
                                                            </h4>
                                                            <div class="post-exeption">
                                                                <p>${description}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </article>
                                            </div>`
                                        )
                                    }
                                }
                            }
                            else {
                                console.log('No data')
                            }
                        },
                        error: function (error) {
                            console.log(error)
                    }
                    })
                });
            </script>

            <div class="cell-sm-10 cell-md-4">
                <div class="widget-list">
                    {% get_search %}
                    {% get_archive %}
                    {% get_gallery %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}